{% extends "base.html" %}
{% block content %}
  <section class="card upload-card">
    <h2>Upload a File</h2>
    <form id="upload-form" class="upload-form" method="post" action="{{ url_for('fileupload') }}" enctype="multipart/form-data">
      <div class="form-row">
        <label class="form-control">
          <span>File</span>
          <input type="file" name="file" required />
        </label>
        <label class="form-control">
          <span>Retention (hours)</span>
          <input
            type="number"
            name="retention_hours"
            step="0.1"
            min="{{ config.retention_min_hours }}"
            max="{{ config.retention_max_hours }}"
            value="{{ config.retention_hours }}"
            required
          />
          <small>Allowed: {{ config.retention_min_hours|round(2) }}&ndash;{{ config.retention_max_hours|round(2) }} hours</small>
        </label>
      </div>
      <button type="submit" class="button primary">
        <span class="icon" aria-hidden="true">‚¨ÜÔ∏è</span>
        <span class="label">Upload</span>
      </button>
    </form>
    <div id="upload-progress" class="progress hidden" aria-hidden="true">
      <div id="upload-progress-bar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div id="upload-status" class="status-message" role="status" aria-live="polite"></div>
    <p class="help-text">
      Files will remain available for at least {{ config.retention_min_hours|round(2) }} hours and at most
      {{ config.retention_max_hours|round(2) }} hours. The default for new uploads is {{ config.retention_hours|round(2) }} hours.
    </p>
  </section>
  <section class="card">
    <h2>Uploaded Files</h2>
    {% if files %}
      <table class="file-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Size</th>
            <th>Uploaded</th>
            <th>Expires</th>
            <th>Time Remaining</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
            <tr>
              <td>{{ file.original_name }}</td>
              <td>{{ file.size|human_filesize }}</td>
              <td>{{ file.uploaded_at|human_datetime }}</td>
              <td>{{ file.expires_at|human_datetime }}</td>
              <td class="time-remaining">{{ file.remaining_seconds|human_timedelta }}</td>
              <td>
                <a href="{{ file.download_url }}" class="button">
                  <span class="icon" aria-hidden="true">‚¨áÔ∏è</span>
                  <span class="label">Download</span>
                </a>
                <a
                  href="{{ file.direct_download_url }}"
                  class="button secondary"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <span class="icon" aria-hidden="true">üîó</span>
                  <span class="label">Direct Link</span>
                </a>
                {% if file.raw_download_url %}
                  <a
                    href="{{ file.raw_download_url }}"
                    class="button secondary"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <span class="icon" aria-hidden="true">üåê</span>
                    <span class="label">Raw URL</span>
                  </a>
                {% endif %}
                <form method="post" action="{{ url_for('hosting_delete', file_id=file.id) }}" class="inline-form" onsubmit="return confirm('Delete this file?');">
                  <button type="submit" class="button danger">
                    <span class="icon" aria-hidden="true">üóëÔ∏è</span>
                    <span class="label">Delete</span>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No files have been uploaded yet.</p>
    {% endif %}
  </section>

{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('upload-form');
      if (!form) {
        return;
      }
      const statusEl = document.getElementById('upload-status');
      const progressContainer = document.getElementById('upload-progress');
      const progressBar = document.getElementById('upload-progress-bar');
      const submitButton = form.querySelector('button[type="submit"]');

      const resetProgress = () => {
        progressBar.style.width = '0%';
        progressBar.removeAttribute('aria-valuenow');
        progressContainer.classList.add('hidden');
      };

      const showStatus = (message, type = 'info', links = []) => {
        statusEl.textContent = '';
        statusEl.className = `status-message ${type}`;
        if (!message) {
          return;
        }
        const span = document.createElement('span');
        span.textContent = message;
        statusEl.append(span);
        const normalizedLinks = Array.isArray(links) ? links : links ? [links] : [];
        normalizedLinks.forEach((link, index) => {
          if (!link || !link.href || !link.text) {
            return;
          }
          const linkEl = document.createElement('a');
          linkEl.href = link.href;
          linkEl.textContent = link.text;
          linkEl.target = '_blank';
          linkEl.rel = 'noopener noreferrer';
          statusEl.append(index === 0 ? ' ' : ' | ');
          statusEl.append(linkEl);
        });
      };

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput.files || !fileInput.files.length) {
          showStatus('Select a file to upload.', 'error');
          return;
        }

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);

        xhr.upload.addEventListener('loadstart', () => {
          submitButton.disabled = true;
          progressContainer.classList.remove('hidden');
          progressBar.style.width = '0%';
          progressBar.setAttribute('aria-valuenow', '0');
          showStatus('Starting upload‚Ä¶', 'info');
        });

        xhr.upload.addEventListener('progress', (event) => {
          if (!event.lengthComputable) {
            return;
          }
          const percent = Math.round((event.loaded / event.total) * 100);
          progressBar.style.width = `${percent}%`;
          progressBar.setAttribute('aria-valuenow', String(percent));
          showStatus(`Uploading‚Ä¶ ${percent}%`, 'info');
        });

        xhr.addEventListener('error', () => {
          submitButton.disabled = false;
          showStatus('Network error during upload.', 'error');
          resetProgress();
        });

        xhr.onreadystatechange = () => {
          if (xhr.readyState !== XMLHttpRequest.DONE) {
            return;
          }
          submitButton.disabled = false;
          let response;
          try {
            response = JSON.parse(xhr.responseText || '{}');
          } catch (error) {
            response = {};
          }

          if (xhr.status >= 200 && xhr.status < 300) {
            const filename = response.filename || 'File';
            const retention = response.retention_hours != null ? `Retained for ${response.retention_hours} hours.` : '';
            const links = [];
            if (response.download_url) {
              links.push({ href: response.download_url, text: 'Download' });
            }
            if (response.direct_download_url) {
              links.push({ href: response.direct_download_url, text: 'Direct Link' });
            }
            if (response.raw_download_url) {
              links.push({ href: response.raw_download_url, text: 'Raw URL' });
            }
            const message = retention
              ? `Upload complete: ${filename}. ${retention}`
              : `Upload complete: ${filename}.`;
            showStatus(message, 'success', links);
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', '100');
            form.reset();
            setTimeout(() => {
              window.location.reload();
            }, 1200);
          } else {
            const errorMessage = response.error || 'Upload failed.';
            showStatus(errorMessage, 'error');
            resetProgress();
          }
        };

        xhr.send(formData);
      });
    });
  </script>
{% endblock %}
