{% extends "base.html" %}
{% block content %}
  <section class="card">
    <h2>Uploaded Files</h2>
    <div class="file-controls">
      <form method="get" action="{{ url_for('hosting') }}" class="search-form">
        <input
          type="text"
          name="search"
          placeholder="Search files..."
          value="{{ search }}"
          aria-label="Search files"
        />
        <input type="hidden" name="sort" value="{{ sort_by }}" />
        <input type="hidden" name="order" value="{{ sort_order }}" />
        <input type="hidden" name="per_page" value="{{ per_page }}" />
        <button type="submit" class="button secondary">🔍 Search</button>
        {% if search %}
          <a href="{{ url_for('hosting', sort=sort_by, order=sort_order, per_page=per_page) }}" class="button">Clear</a>
        {% endif %}
      </form>
    </div>

    <div class="pagination-info">
      {% if total_files %}
        {% set start_index = ((page - 1) * per_page) + 1 %}
        {% set end_index = [page * per_page, total_files]|min %}
        <p>Showing {{ start_index }}-{{ end_index }} of {{ total_files }} files</p>
      {% else %}
        <p>No files found.</p>
      {% endif %}
    </div>

    {% if files %}
      <table class="file-table">
        <thead>
          <tr>
            <th>
              {% set next_name_order = 'desc' if sort_by == 'name' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='name', order=next_name_order, search=search, per_page=per_page) }}">
                Name {% if sort_by == 'name' %}<span class="sort-indicator">{{ '↑' if sort_order == 'asc' else '↓' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_size_order = 'desc' if sort_by == 'size' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='size', order=next_size_order, search=search, per_page=per_page) }}">
                Size {% if sort_by == 'size' %}<span class="sort-indicator">{{ '↑' if sort_order == 'asc' else '↓' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_uploaded_order = 'desc' if sort_by == 'uploaded_at' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='uploaded_at', order=next_uploaded_order, search=search, per_page=per_page) }}">
                Uploaded {% if sort_by == 'uploaded_at' %}<span class="sort-indicator">{{ '↑' if sort_order == 'asc' else '↓' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_expires_order = 'desc' if sort_by == 'expires_at' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='expires_at', order=next_expires_order, search=search, per_page=per_page) }}">
                Expires {% if sort_by == 'expires_at' %}<span class="sort-indicator">{{ '↑' if sort_order == 'asc' else '↓' }}</span>{% endif %}
              </a>
            </th>
            <th>Time Remaining</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
            <tr>
              <td>{{ file.original_name }}</td>
              <td>{{ file.size|human_filesize }}</td>
              <td>{{ file.uploaded_at|human_datetime }}</td>
              <td>{{ file.expires_at|human_datetime }}</td>
              <td class="time-remaining">{{ file.remaining_seconds|human_timedelta }}</td>
              <td class="actions-cell">
                <a
                  href="{{ file.download_url }}"
                  class="button icon-only"
                  title="Download file"
                  aria-label="Download file"
                >
                  <span class="icon" aria-hidden="true">⬇️</span>
                </a>
                <a
                  href="{{ file.direct_download_url }}"
                  class="button secondary icon-only"
                  title="Open direct link"
                  aria-label="Open direct link"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <span class="icon" aria-hidden="true">🔗</span>
                </a>
                {% if file.raw_download_url %}
                  <a
                    href="{{ file.raw_download_url }}"
                    class="button secondary icon-only"
                    title="Open raw URL"
                    aria-label="Open raw URL"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <span class="icon" aria-hidden="true">🌐</span>
                  </a>
                {% endif %}
                <form method="post" action="{{ url_for('hosting_delete', file_id=file.id) }}" class="inline-form" onsubmit="return confirm('Delete this file?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button
                    type="submit"
                    class="button danger icon-only"
                    title="Delete file"
                    aria-label="Delete file"
                  >
                    <span class="icon" aria-hidden="true">🗑️</span>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination">
        {% if page > 1 %}
          <a
            href="{{ url_for('hosting', page=page-1, sort=sort_by, order=sort_order, search=search, per_page=per_page) }}"
            class="button secondary"
            >← Previous</a
          >
        {% endif %}
        <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
        {% if page < total_pages %}
          <a
            href="{{ url_for('hosting', page=page+1, sort=sort_by, order=sort_order, search=search, per_page=per_page) }}"
            class="button secondary"
            >Next →</a
          >
        {% endif %}
      </div>
    {% else %}
      {% if search %}
        <p>No files match your search.</p>
      {% else %}
        <p>No files have been uploaded yet.</p>
      {% endif %}
    {% endif %}
  </section>
{% endblock %}
