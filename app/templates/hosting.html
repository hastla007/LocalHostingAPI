{% extends "base.html" %}
{% block content %}
  <section class="card">
    <h2>Uploaded Files</h2>
    <div class="file-controls">
      <form method="get" action="{{ url_for('hosting') }}" class="search-form">
        <input
          type="text"
          name="search"
          placeholder="Search files..."
          value="{{ search }}"
          aria-label="Search files"
        />
        <input type="hidden" name="sort" value="{{ sort_by }}" />
        <input type="hidden" name="order" value="{{ sort_order }}" />
        <input type="hidden" name="per_page" value="{{ per_page }}" />
        <button type="submit" class="button secondary">üîç Search</button>
        {% if search %}
          <a href="{{ url_for('hosting', sort=sort_by, order=sort_order, per_page=per_page) }}" class="button">Clear</a>
        {% endif %}
      </form>
    </div>

    <div class="pagination-info">
      {% if total_files %}
        {% set start_index = ((page - 1) * per_page) + 1 %}
        {% set end_index = [page * per_page, total_files]|min %}
        <p>Showing {{ start_index }}-{{ end_index }} of {{ total_files }} files</p>
      {% else %}
        <p>No files found.</p>
      {% endif %}
    </div>

    {% if files %}
      <table class="file-table">
        <thead>
          <tr>
            <th>
              {% set next_name_order = 'desc' if sort_by == 'name' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='name', order=next_name_order, search=search, per_page=per_page) }}">
                Name {% if sort_by == 'name' %}<span class="sort-indicator">{{ '‚Üë' if sort_order == 'asc' else '‚Üì' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_size_order = 'desc' if sort_by == 'size' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='size', order=next_size_order, search=search, per_page=per_page) }}">
                Size {% if sort_by == 'size' %}<span class="sort-indicator">{{ '‚Üë' if sort_order == 'asc' else '‚Üì' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_uploaded_order = 'desc' if sort_by == 'uploaded_at' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='uploaded_at', order=next_uploaded_order, search=search, per_page=per_page) }}">
                Uploaded {% if sort_by == 'uploaded_at' %}<span class="sort-indicator">{{ '‚Üë' if sort_order == 'asc' else '‚Üì' }}</span>{% endif %}
              </a>
            </th>
            <th>
              {% set next_expires_order = 'desc' if sort_by == 'expires_at' and sort_order == 'asc' else 'asc' %}
              <a href="{{ url_for('hosting', sort='expires_at', order=next_expires_order, search=search, per_page=per_page) }}">
                Expires {% if sort_by == 'expires_at' %}<span class="sort-indicator">{{ '‚Üë' if sort_order == 'asc' else '‚Üì' }}</span>{% endif %}
              </a>
            </th>
            <th>Time Remaining</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
            <tr>
              <td>{{ file.original_name }}</td>
              <td>{{ file.size|human_filesize }}</td>
              <td>{{ file.uploaded_at|human_datetime }}</td>
              <td>{{ file.expires_at|human_datetime }}</td>
              <td class="time-remaining">
                {% if file.permanent %}
                  <span style="color: #059669; font-weight: 600;">‚àû Permanent</span>
                {% else %}
                  {{ file.remaining_seconds|human_timedelta }}
                {% endif %}
              </td>
              <td class="actions-cell">
                <a
                  href="{{ file.download_url }}"
                  class="button icon-only"
                  title="Download file"
                  aria-label="Download file"
                >
                  <span class="icon" aria-hidden="true">‚¨áÔ∏è</span>
                </a>
                <button
                  type="button"
                  class="button secondary icon-only copy-link-btn"
                  title="Copy direct link"
                  aria-label="Copy direct link"
                  data-url="{{ file.direct_download_url }}"
                  data-filename="{{ file.original_name }}"
                >
                  <span class="icon" aria-hidden="true">üîó</span>
                </button>
                {% if file.raw_download_url %}
                  <a
                    href="{{ file.raw_download_url }}"
                    class="button secondary icon-only"
                    title="Open raw URL"
                    aria-label="Open raw URL"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <span class="icon" aria-hidden="true">üåê</span>
                  </a>
                {% endif %}
                <form 
                  method="post" 
                  action="{{ url_for('hosting_delete', file_id=file.id) }}" 
                  class="inline-form delete-form"
                  data-filename="{{ file.original_name }}"
                  onsubmit="return confirmDelete(this, event);"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <input type="hidden" name="page" value="{{ page }}" />
                  <input type="hidden" name="per_page" value="{{ per_page }}" />
                  <input type="hidden" name="sort" value="{{ sort_by }}" />
                  <input type="hidden" name="order" value="{{ sort_order }}" />
                  <input type="hidden" name="search" value="{{ search }}" />
                  <button
                    type="submit"
                    class="button danger icon-only"
                    title="Delete file"
                    aria-label="Delete file"
                  >
                    <span class="icon" aria-hidden="true">üóëÔ∏è</span>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination">
        {% if page > 1 %}
          <a
            href="{{ url_for('hosting', page=page-1, sort=sort_by, order=sort_order, search=search, per_page=per_page) }}"
            class="button secondary"
            >‚Üê Previous</a
          >
        {% endif %}
        <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
        {% if page < total_pages %}
          <a
            href="{{ url_for('hosting', page=page+1, sort=sort_by, order=sort_order, search=search, per_page=per_page) }}"
            class="button secondary"
            >Next ‚Üí</a
          >
        {% endif %}
      </div>
    {% else %}
      {% if search %}
        <p>No files match your search.</p>
      {% else %}
        <p>No files have been uploaded yet.</p>
      {% endif %}
    {% endif %}
  </section>

  <!-- Toast notification for copy feedback -->
  <div id="copy-toast" class="copy-toast hidden" role="status" aria-live="polite">
    <span class="copy-toast-icon">‚úì</span>
    <span class="copy-toast-text"></span>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // Global delete confirmation function
    function confirmDelete(form, event) {
      event.preventDefault();
      event.stopPropagation();
      
      const filename = form.getAttribute('data-filename') || 'this file';
      const action = form.getAttribute('action');
      
      console.log('Delete requested for:', filename);
      console.log('Form action:', action);
      console.log('Form method:', form.getAttribute('method'));
      
      const confirmMsg = 'Delete "' + filename + '"?\n\nThis action cannot be undone.';
      
      if (window.confirm(confirmMsg)) {
        console.log('User confirmed - submitting form');
        
        // Show loading state on button
        const button = form.querySelector('button[type="submit"]');
        if (button) {
          const icon = button.querySelector('.icon');
          if (icon) {
            icon.textContent = '‚è≥';
          }
          button.disabled = true;
          button.style.opacity = '0.5';
        }
        
        // Submit the form
        try {
          form.submit();
          console.log('Form submitted successfully');
          return true;
        } catch (err) {
          console.error('Error submitting form:', err);
          alert('Error: ' + err.message);
          
          // Restore button
          if (button) {
            const icon = button.querySelector('.icon');
            if (icon) {
              icon.textContent = 'üóëÔ∏è';
            }
            button.disabled = false;
            button.style.opacity = '1';
          }
          return false;
        }
      } else {
        console.log('User cancelled delete');
        return false;
      }
    }
    
    // Make it available globally
    window.confirmDelete = confirmDelete;

    // Copy link functionality
    (function() {
      const copyButtons = document.querySelectorAll('.copy-link-btn');
      const toast = document.getElementById('copy-toast');
      const toastText = toast ? toast.querySelector('.copy-toast-text') : null;
      let toastTimeout = null;

      console.log('Found ' + copyButtons.length + ' copy buttons');

      function showToast(message, duration) {
        duration = duration || 2000;
        if (!toast || !toastText) return;
        if (toastTimeout) {
          clearTimeout(toastTimeout);
        }
        toastText.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('show');
        toastTimeout = setTimeout(function() {
          toast.classList.remove('show');
          setTimeout(function() {
            toast.classList.add('hidden');
          }, 300);
        }, duration);
      }

      function copyToClipboard(text, filename) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text)
            .then(function() {
              showToast('Link copied: ' + filename);
            })
            .catch(function(err) {
              console.error('Clipboard API failed:', err);
              fallbackCopy(text, filename);
            });
        } else {
          fallbackCopy(text, filename);
        }
      }

      function fallbackCopy(text, filename) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        
        try {
          textarea.focus();
          textarea.select();
          const successful = document.execCommand('copy');
          if (successful) {
            showToast('Link copied: ' + filename);
          } else {
            showToast('Failed to copy link', 3000);
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          showToast('Copy not supported in this browser', 3000);
        } finally {
          document.body.removeChild(textarea);
        }
      }

      copyButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const url = this.getAttribute('data-url');
          const filename = this.getAttribute('data-filename');
          
          if (url) {
            const absoluteUrl = url.startsWith('http') ? url : window.location.origin + url;
            copyToClipboard(absoluteUrl, filename || absoluteUrl);
          }
        });
      });
    })();
    
    console.log('All hosting page scripts loaded');
  </script>
{% endblock %}
