{% extends "base.html" %}
{% block content %}
  <section class="card">
    <h2>UI Authentication</h2>
    <form method="post" class="form-grid auth-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="action" value="update_ui_auth" />

      <label for="ui_auth_enabled" class="checkbox-label">
        <input
          type="checkbox"
          id="ui_auth_enabled"
          name="ui_auth_enabled"
          {% if config.ui_auth_enabled %}checked{% endif %}
        />
        Require login for dashboard pages
      </label>

      <label for="ui_username">Username</label>
      <input
        type="text"
        id="ui_username"
        name="ui_username"
        value="{{ config.ui_username }}"
        autocomplete="username"
      />

      <label for="ui_password">New password</label>
      <input
        type="password"
        id="ui_password"
        name="ui_password"
        autocomplete="new-password"
        placeholder="Leave blank to keep current password"
      />

      <label for="ui_password_confirm">Confirm password</label>
      <input
        type="password"
        id="ui_password_confirm"
        name="ui_password_confirm"
        autocomplete="new-password"
        placeholder="Repeat new password"
      />

      <p class="form-help">
        Authentication is optional by default. Enable it to require users to log in before accessing the dashboard. Leave the
        password fields blank to keep the existing password.
      </p>

      <button type="submit" class="button primary">Update Authentication</button>
    </form>
  </section>

  <div class="settings-row">
    <section class="card retention-card">
      <h2>Retention Settings</h2>
      <form method="post" class="retention-system-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="action" value="update_retention" />

        <div class="form-grid">
          <label for="retention_min_hours">Minimum retention (hours)</label>
          <input
            type="number"
            id="retention_min_hours"
            name="retention_min_hours"
            min="0"
            step="0.1"
            value="{{ config.retention_min_hours }}"
            required
          />

          <label for="retention_max_hours">Maximum retention (hours)</label>
          <input
            type="number"
            id="retention_max_hours"
            name="retention_max_hours"
            min="0"
            step="0.1"
            value="{{ config.retention_max_hours }}"
            required
          />

          <label for="retention_hours">Default retention (hours)</label>
          <input
            type="number"
            id="retention_hours"
            name="retention_hours"
            min="0"
            step="0.1"
            value="{{ config.retention_hours }}"
            required
          />
        </div>

        <div class="form-actions">
          <button type="submit" class="button primary">Save</button>
        </div>
      </form>
      <p>
        Each upload can now request its own retention period within the allowed range. Values outside of the configured bounds
        will be rejected by the API and the dashboard uploader.
      </p>
    </section>
    <section class="card storage-card">
      <h2>Storage Management</h2>
      <table class="settings-table">
        <tbody>
          <tr>
            <th scope="row">Total storage used</th>
            <td>{{ '%.3f'|format(storage_overview.total_gb) }} GB</td>
          </tr>
          <tr>
            <th scope="row">Active files</th>
            <td>{{ storage_overview.active_count }}</td>
          </tr>
          <tr>
            <th scope="row">Expired files pending cleanup</th>
            <td>{{ storage_overview.expired_count }}</td>
          </tr>
          <tr>
            <th scope="row">Storage quota limit</th>
            <td>
              {% if storage_quota_limit is not none %}
                {{ '%.2f'|format(storage_quota_limit) }} GB
              {% else %}
                <span class="text-muted">Not configured</span>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>
      <div class="settings-action-row">
        <form method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="action" value="cleanup_expired_now" />
          <button type="submit" class="button primary">Cleanup Expired Files Now</button>
        </form>
        <form method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="action" value="cleanup_orphaned_now" />
          <button type="submit" class="button secondary">Remove Orphaned Files</button>
        </form>
      </div>
      <p class="form-help">
        Values reflect the current environment configuration. Future releases will allow adjusting these storage controls directly
        within the dashboard.
      </p>
    </section>
  </div>

  <section class="card">
    <h2>Performance Settings</h2>
    <form method="post" class="performance-form" id="performance-form" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf-token" />
      <input type="hidden" name="action" value="update_performance" />
      <table class="settings-table">
        <tbody>
          <tr>
            <th scope="row">
              <label for="max_upload_size_mb">Maximum upload size (MB)</label>
            </th>
            <td>
              <input
                type="number"
                id="max_upload_size_mb"
                name="max_upload_size_mb"
                min="1"
                max="10000"
                step="any"
                value="{{ performance_settings.max_upload_size_mb }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
          <tr>
            <th scope="row">
              <label for="max_concurrent_uploads">Max concurrent uploads</label>
            </th>
            <td>
              <input
                type="number"
                id="max_concurrent_uploads"
                name="max_concurrent_uploads"
                min="1"
                max="100"
                step="1"
                value="{{ performance_settings.max_concurrent_uploads }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
          <tr>
            <th scope="row">
              <label for="cleanup_interval_minutes">Cleanup interval (minutes)</label>
            </th>
            <td>
              <input
                type="number"
                id="cleanup_interval_minutes"
                name="cleanup_interval_minutes"
                min="1"
                max="1440"
                step="1"
                value="{{ performance_settings.cleanup_interval_minutes }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
          <tr>
            <th scope="row">
              <label for="upload_rate_limit_per_hour">Upload requests per hour</label>
            </th>
            <td>
              <input
                type="number"
                id="upload_rate_limit_per_hour"
                name="upload_rate_limit_per_hour"
                min="1"
                max="10000"
                step="1"
                value="{{ performance_settings.rate_limits.upload_per_hour }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
          <tr>
            <th scope="row">
              <label for="login_rate_limit_per_minute">Login attempts per minute</label>
            </th>
            <td>
              <input
                type="number"
                id="login_rate_limit_per_minute"
                name="login_rate_limit_per_minute"
                min="1"
                max="1000"
                step="1"
                value="{{ performance_settings.rate_limits.login_per_minute }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
          <tr>
            <th scope="row">
              <label for="download_rate_limit_per_minute">Download requests per minute</label>
            </th>
            <td>
              <input
                type="number"
                id="download_rate_limit_per_minute"
                name="download_rate_limit_per_minute"
                min="1"
                max="10000"
                step="1"
                value="{{ performance_settings.rate_limits.download_per_minute }}"
                required
                class="performance-input"
              />
            </td>
          </tr>
        </tbody>
      </table>
      <div class="form-actions">
        <button type="submit" class="button primary" id="save-performance-btn">Save Performance Settings</button>
        <button type="button" class="button secondary" id="test-form-btn">Test Form Data</button>
      </div>
    </form>
    <div id="form-debug" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-family: monospace; font-size: 12px; display: none;">
      <strong>Form Debug Info:</strong>
      <pre id="form-debug-content"></pre>
    </div>
    <p class="form-help">
      These limits update immediately after saving. The scheduler interval applies to background cleanup jobs and may take up to
      one full interval to reflect the new cadence.
    </p>
  </section>
  <section class="card">
    <h2>File Management Policies</h2>
    <table class="settings-table">
      <tbody>
        <tr>
          <th scope="row">Blocked file extensions</th>
          <td>
            {% if file_policy_settings.blocked_extensions %}
              {{ file_policy_settings.blocked_extensions | join(', ') }}
            {% else %}
              <span class="text-muted">None configured</span>
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
    <p class="form-help">
      These policies are read from environment variables today. Capturing them here keeps operators informed until the values
      can be edited directly through the dashboard.
    </p>
  </section>

  <!-- Debug panel -->
  <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: #333; color: #fff; padding: 15px; font-size: 12px; border-radius: 5px; max-width: 400px; max-height: 300px; overflow-y: auto; display: none; z-index: 10000;">
    <strong>Debug Log:</strong> <button onclick="document.getElementById('debug-panel').style.display='none'" style="float: right; background: #666; color: #fff; border: none; padding: 2px 8px; cursor: pointer;">Close</button>
    <div id="debug-log" style="margin-top: 10px; font-family: monospace;"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // Debug system
    const debugLog = [];
    function addDebug(msg, type) {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '[ERROR]' : type === 'warn' ? '[WARN]' : '[DEBUG]';
      const fullMsg = timestamp + ' ' + prefix + ' ' + msg;
      
      console.log(fullMsg);
      debugLog.push(fullMsg);
      
      const debugEl = document.getElementById('debug-log');
      if (debugEl) {
        debugEl.innerHTML = debugLog.slice(-20).map(function(m) {
          if (m.includes('[ERROR]')) {
            return '<div style="color: #ff6b6b;">' + m + '</div>';
          } else if (m.includes('[WARN]')) {
            return '<div style="color: #ffd93d;">' + m + '</div>';
          }
          return '<div>' + m + '</div>';
        }).join('');
      }
    }

    // Show debug panel with Ctrl+Shift+D
    window.addEventListener('keydown', function(e) {
      if (e.key === 'D' && e.ctrlKey && e.shiftKey) {
        const panel = document.getElementById('debug-panel');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
      }
    });

    addDebug('Settings page script loaded');

    // Performance form handling
    (function() {
      const form = document.getElementById('performance-form');
      const saveBtn = document.getElementById('save-performance-btn');
      const testBtn = document.getElementById('test-form-btn');
      const formDebug = document.getElementById('form-debug');
      const formDebugContent = document.getElementById('form-debug-content');
      const csrfInput = document.getElementById('csrf-token');

      if (!form) {
        addDebug('ERROR: Performance form not found!', 'error');
        return;
      }

      addDebug('Performance form found');
      addDebug('Form action: ' + form.getAttribute('action'));
      addDebug('Form method: ' + form.getAttribute('method'));
      
      if (csrfInput) {
        addDebug('CSRF token present: ' + csrfInput.value.substring(0, 15) + '...');
      } else {
        addDebug('WARNING: No CSRF token found!', 'warn');
      }

      // Test button to show form data without submitting
      if (testBtn) {
        testBtn.addEventListener('click', function(e) {
          e.preventDefault();
          addDebug('Test button clicked');
          
          const formData = new FormData(form);
          const data = {};
          let output = '';
          
          for (let [key, value] of formData.entries()) {
            data[key] = value;
            output += key + ': ' + value + '\n';
            addDebug('Field ' + key + ' = ' + value);
          }
          
          if (formDebugContent) {
            formDebugContent.textContent = output;
          }
          if (formDebug) {
            formDebug.style.display = 'block';
          }
          
          addDebug('Form data collected: ' + Object.keys(data).length + ' fields');
          
          // Show debug panel
          const panel = document.getElementById('debug-panel');
          if (panel) {
            panel.style.display = 'block';
          }
        });
      }

      // Form submission handler
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        addDebug('Form submission intercepted');

        // Collect all form data
        const formData = new FormData(this);
        const values = {};
        
        for (let [key, value] of formData.entries()) {
          values[key] = value;
          addDebug('Submit field: ' + key + ' = ' + value);
        }

        // Check action field
        if (values.action !== 'update_performance') {
          addDebug('WARNING: action field is "' + values.action + '" instead of "update_performance"', 'warn');
        }

        // Validate required fields
        const requiredFields = [
          'max_upload_size_mb',
          'max_concurrent_uploads',
          'cleanup_interval_minutes',
          'upload_rate_limit_per_hour',
          'login_rate_limit_per_minute',
          'download_rate_limit_per_minute'
        ];

        const missingFields = [];
        const invalidFields = [];

        for (let field of requiredFields) {
          const value = values[field];
          
          if (!value || value === '') {
            missingFields.push(field);
            addDebug('ERROR: Missing field: ' + field, 'error');
          } else {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
              invalidFields.push(field + ' (not a number)');
              addDebug('ERROR: Invalid number in ' + field + ': ' + value, 'error');
            } else if (numValue < 1) {
              invalidFields.push(field + ' (must be >= 1)');
              addDebug('ERROR: Value too small in ' + field + ': ' + value, 'error');
            } else {
              addDebug('Valid: ' + field + ' = ' + numValue);
            }
          }
        }

        if (missingFields.length > 0) {
          const msg = 'Missing required fields:\n' + missingFields.join('\n');
          alert(msg);
          addDebug('Validation failed: missing fields', 'error');
          // Show debug panel
          document.getElementById('debug-panel').style.display = 'block';
          return false;
        }

        if (invalidFields.length > 0) {
          const msg = 'Invalid values:\n' + invalidFields.join('\n');
          alert(msg);
          addDebug('Validation failed: invalid values', 'error');
          // Show debug panel
          document.getElementById('debug-panel').style.display = 'block';
          return false;
        }

        addDebug('All validation passed');

        // Update button state
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
          saveBtn.style.opacity = '0.6';
        }

        addDebug('Submitting form now...');

        // Submit the form
        try {
          this.submit();
          addDebug('Form submitted successfully');
        } catch (err) {
          addDebug('ERROR: Form submission failed: ' + err.message, 'error');
          alert('Error submitting form: ' + err.message);
          
          // Restore button
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Performance Settings';
            saveBtn.style.opacity = '1';
          }
          
          // Show debug panel
          document.getElementById('debug-panel').style.display = 'block';
        }
      });

      addDebug('Form submission handler attached');
    })();

    addDebug('All scripts initialized');
  </script>
{% endblock %}
