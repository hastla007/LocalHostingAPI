{% extends "base.html" %}
{% block content %}
  <section class="card upload-card">
    <h2>Upload a File</h2>
    <form id="upload-form" class="upload-form" method="post" action="{{ url_for('fileupload') }}" enctype="multipart/form-data">
      <div
        id="drop-zone"
        class="drop-zone"
        tabindex="0"
        role="button"
        aria-label="Select or drop a file to upload"
        aria-describedby="drop-zone-instructions drop-zone-filename"
      >
        <input id="file-input" type="file" name="file" required class="visually-hidden" />
        <div class="drop-zone-body">
          <span class="drop-zone-icon" aria-hidden="true">üìÅ</span>
          <button type="button" class="button secondary drop-zone-trigger" id="file-select-button">
            Select a File
          </button>
          <p id="drop-zone-instructions" class="drop-zone-text">‚Ä¶or drag and drop a file anywhere in this area.</p>
          <p id="drop-zone-filename" class="drop-zone-file" aria-live="polite"></p>
        </div>
      </div>
      <div class="form-row form-row-actions">
        <label class="form-control">
          <span>Retention (hours)</span>
          <input
            type="number"
            name="retention_hours"
            step="0.1"
            min="{{ config.retention_min_hours }}"
            max="{{ config.retention_max_hours }}"
            value="{{ config.retention_hours }}"
            required
          />
          <small>Allowed: {{ config.retention_min_hours|round(2) }}&ndash;{{ config.retention_max_hours|round(2) }} hours</small>
        </label>
        <button
          type="submit"
          class="button primary"
          title="Upload file"
          aria-label="Upload file"
        >
          <span class="icon" aria-hidden="true">‚¨ÜÔ∏è</span>
          <span class="label">Upload</span>
        </button>
      </div>
    </form>
    <div id="upload-progress" class="progress hidden" aria-hidden="true">
      <div id="upload-progress-bar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div id="upload-status" class="status-message" role="status" aria-live="polite"></div>
    <p class="help-text">
      Files will remain available for at least {{ config.retention_min_hours|round(2) }} hours and at most
      {{ config.retention_max_hours|round(2) }} hours. The default for new uploads is {{ config.retention_hours|round(2) }} hours.
    </p>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('upload-form');
      if (!form) {
        return;
      }
      const statusEl = document.getElementById('upload-status');
      const progressContainer = document.getElementById('upload-progress');
      const progressBar = document.getElementById('upload-progress-bar');
      const submitButton = form.querySelector('button[type="submit"]');
      const fileInput = document.getElementById('file-input');
      const dropZone = document.getElementById('drop-zone');
      const dropZoneFileName = document.getElementById('drop-zone-filename');
      const fileSelectButton = document.getElementById('file-select-button');
      const retentionInput = form.querySelector('input[name="retention_hours"]');
      let lastDroppedFile = null;

      const resetProgress = () => {
        progressBar.style.width = '0%';
        progressBar.removeAttribute('aria-valuenow');
        progressContainer.classList.add('hidden');
      };

      const showStatus = (message, type = 'info', links = []) => {
        statusEl.textContent = '';
        statusEl.className = `status-message ${type}`;
        if (!message) {
          return;
        }
        const span = document.createElement('span');
        span.textContent = message;
        statusEl.append(span);
        const normalizedLinks = Array.isArray(links) ? links : links ? [links] : [];
        normalizedLinks.forEach((link, index) => {
          if (!link || !link.href || !link.text) {
            return;
          }
          const linkEl = document.createElement('a');
          linkEl.href = link.href;
          linkEl.textContent = link.text;
          linkEl.target = '_blank';
          linkEl.rel = 'noopener noreferrer';
          statusEl.append(index === 0 ? ' ' : ' | ');
          statusEl.append(linkEl);
        });
      };

      const updateDropZoneState = (filename) => {
        if (!dropZone || !dropZoneFileName) {
          return;
        }
        if (filename) {
          dropZoneFileName.textContent = `Selected: ${filename}`;
          dropZone.classList.add('has-file');
        } else {
          dropZoneFileName.textContent = '';
          dropZone.classList.remove('has-file');
        }
      };

      const handleUpload = (fileOverride) => {
        const activeFile = fileOverride || (fileInput && fileInput.files && fileInput.files[0]) || lastDroppedFile;
        if (!activeFile) {
          showStatus('Select a file to upload.', 'error');
          return;
        }

        const formData = new FormData(form);
        if (activeFile) {
          formData.delete('file');
          formData.append('file', activeFile, activeFile.name);
        }
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);

        xhr.upload.addEventListener('loadstart', () => {
          submitButton.disabled = true;
          if (retentionInput) {
            retentionInput.setAttribute('aria-busy', 'true');
          }
          progressContainer.classList.remove('hidden');
          progressBar.style.width = '0%';
          progressBar.setAttribute('aria-valuenow', '0');
          showStatus('Starting upload‚Ä¶', 'info');
        });

        xhr.upload.addEventListener('progress', (event) => {
          if (!event.lengthComputable) {
            return;
          }
          const percent = Math.round((event.loaded / event.total) * 100);
          progressBar.style.width = `${percent}%`;
          progressBar.setAttribute('aria-valuenow', String(percent));
          showStatus(`Uploading‚Ä¶ ${percent}%`, 'info');
        });

        xhr.addEventListener('error', () => {
          submitButton.disabled = false;
          if (retentionInput) {
            retentionInput.removeAttribute('aria-busy');
          }
          showStatus('Network error during upload.', 'error');
          resetProgress();
        });

        xhr.onreadystatechange = () => {
          if (xhr.readyState !== XMLHttpRequest.DONE) {
            return;
          }
          submitButton.disabled = false;
          if (retentionInput) {
            retentionInput.removeAttribute('aria-busy');
          }
          let response;
          try {
            response = JSON.parse(xhr.responseText || '{}');
          } catch (error) {
            response = {};
          }

          if (xhr.status >= 200 && xhr.status < 300) {
            const filename = response.filename || 'File';
            const retention = response.retention_hours != null ? `Retained for ${response.retention_hours} hours.` : '';
            const links = [];
            if (response.download_url) {
              links.push({ href: response.download_url, text: 'Download' });
            }
            if (response.direct_download_url) {
              links.push({ href: response.direct_download_url, text: 'Direct Link' });
            }
            if (response.raw_download_url) {
              links.push({ href: response.raw_download_url, text: 'Raw URL' });
            }
            const message = retention
              ? `Upload complete: ${filename}. ${retention}`
              : `Upload complete: ${filename}.`;
            showStatus(message, 'success', links);
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', '100');
            form.reset();
            lastDroppedFile = null;
            updateDropZoneState();
            setTimeout(() => {
              window.location.reload();
            }, 1200);
          } else {
            const errorMessage = response.error || 'Upload failed.';
            showStatus(errorMessage, 'error');
            resetProgress();
          }
        };

        xhr.send(formData);
      };

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        handleUpload();
      });

      const setFileSelection = (file, { autoUpload } = { autoUpload: false }) => {
        if (!file) {
          updateDropZoneState();
          lastDroppedFile = null;
          return;
        }

        let assigned = false;
        if (fileInput && 'files' in fileInput) {
          try {
            if (typeof DataTransfer !== 'undefined') {
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              fileInput.files = dataTransfer.files;
              assigned = true;
            }
          } catch (error) {
            assigned = false;
          }
        }

        lastDroppedFile = assigned ? null : file;
        updateDropZoneState(file.name);
        if (autoUpload) {
          handleUpload(file);
        }
      };

      if (fileInput) {
        fileInput.addEventListener('change', (event) => {
          const files = event.target.files;
          const file = files && files.length ? files[0] : null;
          lastDroppedFile = null;
          if (!file) {
            updateDropZoneState();
            return;
          }
          updateDropZoneState(file.name);
        });
      }

      if (fileSelectButton && fileInput) {
        fileSelectButton.addEventListener('click', () => {
          fileInput.click();
        });
      }

      if (dropZone) {
        const preventDefaults = (event) => {
          event.preventDefault();
          event.stopPropagation();
        };

        ['dragenter', 'dragover'].forEach((eventName) => {
          dropZone.addEventListener(eventName, (event) => {
            preventDefaults(event);
            dropZone.classList.add('dragover');
          });
        });

        ['dragleave', 'dragend', 'drop'].forEach((eventName) => {
          dropZone.addEventListener(eventName, (event) => {
            if (eventName !== 'drop') {
              preventDefaults(event);
            }
            if (
              eventName === 'dragleave' &&
              event.relatedTarget &&
              dropZone.contains(event.relatedTarget)
            ) {
              return;
            }
            dropZone.classList.remove('dragover');
          });
        });

        dropZone.addEventListener('drop', (event) => {
          preventDefaults(event);
          dropZone.classList.remove('dragover');
          const files = event.dataTransfer && event.dataTransfer.files ? event.dataTransfer.files : null;
          if (!files || !files.length) {
            return;
          }

          if (files.length > 1) {
            showStatus('Only the first file will be uploaded.', 'info');
          }

          const [file] = files;
          setFileSelection(file, { autoUpload: true });
        });

        dropZone.addEventListener('click', (event) => {
          if (event.target.closest('button')) {
            return;
          }
          if (fileInput) {
            fileInput.click();
          }
        });

        dropZone.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            if (fileInput) {
              fileInput.click();
            }
          }
        });
      }

      updateDropZoneState();
    });
  </script>
{% endblock %}
