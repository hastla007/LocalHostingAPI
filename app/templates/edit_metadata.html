{% extends "base.html" %}
{% block content %}
  <section class="card">
    <h2>Edit Metadata: {{ file.original_name }}</h2>

    <form id="metadata-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" id="file-id" value="{{ file.id }}" />

      <div class="form-grid" style="max-width: 600px;">
        <label for="title">Title</label>
        <input type="text" id="title" name="title" value="{{ file.metadata.title or '' }}" />

        <label for="artist">Artist / Author</label>
        <input type="text" id="artist" name="artist" value="{{ file.metadata.artist or '' }}" />

        <label for="album">Album / Collection</label>
        <input type="text" id="album" name="album" value="{{ file.metadata.album or '' }}" />

        <label for="duration">Duration (seconds)</label>
        <input type="number" id="duration" name="duration" step="0.01" value="{{ file.metadata.duration or '' }}" />

        <label for="genre">Genre</label>
        <input type="text" id="genre" name="genre" value="{{ file.metadata.genre or '' }}" />

        <label for="year">Year</label>
        <input type="number" id="year" name="year" min="1900" max="2100" value="{{ file.metadata.year or '' }}" />

        <label for="theme">Theme</label>
        <input type="text" id="theme" name="theme" value="{{ file.metadata.theme or '' }}" />

        <label for="description">Description</label>
        <textarea id="description" name="description" rows="4" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #cbd5f5;">{{ file.metadata.description or '' }}</textarea>

        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button type="submit" class="button primary">Save Metadata</button>
          <a href="{{ url_for('view_directory', directory_id=file.directory_id) if file.directory_id else url_for('hosting') }}" class="button secondary">Cancel</a>
        </div>
      </div>
    </form>

    <div id="status-message" class="status-message hidden"></div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.getElementById('metadata-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const fileId = document.getElementById('file-id').value;
      const statusEl = document.getElementById('status-message');

      const metadata = {};
      const fields = ['title', 'artist', 'album', 'duration', 'genre', 'year', 'theme', 'description'];

      fields.forEach(function(field) {
        const input = document.getElementById(field);
        if (!input) return;
        const value = input.value.trim();
        if (value) {
          if (field === 'duration' || field === 'year') {
            const numeric = Number(value);
            if (!Number.isNaN(numeric)) {
              metadata[field] = numeric;
            }
          } else {
            metadata[field] = value;
          }
        }
      });

      try {
        const response = await fetch(`/files/${fileId}/metadata`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ metadata })
        });

        const data = await response.json();

        if (response.ok) {
          statusEl.textContent = 'Metadata saved successfully!';
          statusEl.className = 'status-message success';
          statusEl.classList.remove('hidden');
          setTimeout(function() {
            statusEl.classList.add('hidden');
          }, 3000);
        } else {
          throw new Error(data.error || 'Failed to save metadata');
        }
      } catch (error) {
        statusEl.textContent = 'Error: ' + error.message;
        statusEl.className = 'status-message error';
        statusEl.classList.remove('hidden');
      }
    });
  </script>
{% endblock %}
